name: YTAlertDiscord  # YouTube ìƒˆ ì˜ìƒ ì•Œë¦¼ì„ Discordë¡œ ì „ì†¡

# í•„ìš”í•œ GitHub Secrets (ë ˆí¬ì§€í† ë¦¬ Settings > Secrets and variables > Actionsì—ì„œ ì„¤ì •):
# - CHANNEL_ID: YouTube ì±„ë„ ID (ì˜ˆ: UCxxxxxxxxxxxxxxxxxxxxxx, YouTube ì‚¬ìš©ì í”„ë¡œí•„ > ê³µìœ  > ì±„ë„ ID ë³µì‚¬ë¡œ ê°’ í™•ì¸ ê°€ëŠ¥)
# - DISCORD_WEBHOOK_URL: Discord Webhook URL (Discord ì„œë²„ ì„¤ì •ì—ì„œ ìƒì„±)
# - HASH_SALT: í•´ì‹œìš© ì†”íŠ¸ ë¬¸ìì—´ (ëœë¤ ìƒì„±, ì˜ˆ: `openssl rand -hex 16` ì‹¤í–‰)
# Secretsê°€ ì—†ìœ¼ë©´ ì›Œí¬í”Œë¡œìš°ê°€ ì‹¤íŒ¨í•˜ë‹ˆ ë°˜ë“œì‹œ ì„¤ì •í•˜ì„¸ìš”!

on:
  schedule:
    - cron: "0 */2 * * *"  # 2ì‹œê°„ë§ˆë‹¤ ì‹¤í–‰ (ì˜ˆ: "*/15 * * * *"ë¡œ ë³€ê²½ ì‹œ 15ë¶„ë§ˆë‹¤ ì‹¤í–‰)
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥ (GitHub Actions íƒ­ì—ì„œ íŠ¸ë¦¬ê±°)

permissions:
  contents: write  # state.json í‘¸ì‹œë¥¼ ìœ„í•œ ì“°ê¸° ê¶Œí•œ

jobs:
  notify:
    runs-on: ubuntu-latest
    env:
      MAX_EXTRACT: 5     # RSSì—ì„œ í™•ì¸í•  ìµœëŒ€ ì˜ìƒ ê°œìˆ˜ (ì˜ˆ: 10ìœ¼ë¡œ ëŠ˜ë¦¬ë©´ ë” ë§ì€ ì˜ìƒ í™•ì¸)
      MAX_STORED: 100    # state.jsonì— ì €ì¥í•  ìµœëŒ€ í•´ì‹œ ê°œìˆ˜ (ì˜¤ë˜ëœ ê²ƒë¶€í„° ìë™ ì‚­ì œ)

    steps:
      - name: ì²´í¬ì•„ì›ƒ ì½”ë“œ  # ë ˆí¬ì§€í† ë¦¬ ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
        uses: actions/checkout@v4

      - name: RSS í”¼ë“œ ë‹¤ìš´ë¡œë“œ  # YouTube ì±„ë„ì˜ RSS í”¼ë“œ ê°€ì ¸ì˜¤ê¸°
        id: fetch
        run: |
          RSS_URL="https://www.youtube.com/feeds/videos.xml?channel_id=${{ secrets.CHANNEL_ID }}"
          
          echo "RSS í”¼ë“œ ë‹¤ìš´ë¡œë“œ ì¤‘..."
          if curl -s --fail "$RSS_URL" > feed.xml; then
            echo "RSS í”¼ë“œ ë‹¤ìš´ë¡œë“œ ì„±ê³µ"
          else
            echo "RSS í”¼ë“œ ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨ (CHANNEL_IDê°€ ì˜¬ë°”ë¥¸ì§€ í™•ì¸í•˜ì„¸ìš”)"
            exit 1
          fi

      - name: ìµœì‹  ì˜ìƒ ì •ë³´ ì¶”ì¶œ  # RSSì—ì„œ ì˜ìƒ ID, ì œëª©, ì—…ë¡œë“œ ë‚ ì§œ ì¶”ì¶œ
        id: extract
        run: |
          # ìµœê·¼ MAX_EXTRACT ê°œ ì˜ìƒì˜ ID, ì œëª©, ì—…ë¡œë“œ ì‹œê°„ ì¶”ì¶œ
          grep -oPm${MAX_EXTRACT} "<yt:videoId>[^<]+" feed.xml | sed 's/<yt:videoId>//' > video_ids.txt
          grep -oPm${MAX_EXTRACT} "<title>[^<]+" feed.xml | sed 's/<title>//' > video_titles.txt
          grep -oPm${MAX_EXTRACT} "<published>[^<]+" feed.xml | sed 's/<published>//' > video_dates.txt
          
          echo "ì˜ìƒ ì •ë³´ ì¶”ì¶œ ì™„ë£Œ"

      - name: ì´ì „ ì—…ë¡œë“œ ìƒíƒœ ë¶ˆëŸ¬ì˜¤ê¸°  # state.jsonì—ì„œ ì´ì „ ì˜ìƒ í•´ì‹œ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
        id: state
        run: |
          STATE_FILE=state.json
          if [ -f $STATE_FILE ]; then
            jq -r '.posted[]' $STATE_FILE > prev_hashes.txt 2>/dev/null || touch prev_hashes.txt
          else
            touch prev_hashes.txt
            echo '{"posted":[]}' > $STATE_FILE  # íŒŒì¼ ì—†ìœ¼ë©´ ì´ˆê¸°í™”
          fi
          echo "ì´ì „ í•´ì‹œ ëª©ë¡ ë¡œë“œ ì™„ë£Œ"

      - name: ìƒˆë¡œìš´ ì˜ìƒ í™•ì¸ ë° ì•Œë¦¼ ì „ì†¡  # ìƒˆ ì˜ìƒ í™•ì¸ í›„ Discordë¡œ ì•Œë¦¼ ë³´ë‚´ê¸°
        id: notify
        run: |
          # í•´ì‹œ í•¨ìˆ˜: ì˜ìƒ ID + ì†”íŠ¸ë¥¼ SHA-256ìœ¼ë¡œ í•´ì‹œ
          hash_id() {
            echo -n "$1${{ secrets.HASH_SALT }}" | sha256sum | cut -d ' ' -f1
          }
          
          # ìƒˆ í•´ì‹œ ì €ì¥ìš© íŒŒì¼
          > new_hashes.txt
          > new_videos_info.txt
          
          # ê° ì˜ìƒ í™•ì¸
          line_num=0
          while IFS= read -r video_id; do
            line_num=$((line_num + 1))
            
            # í•´ì‹œ ìƒì„±
            video_hash=$(hash_id "$video_id")
            
            # ê¸°ì¡´ í•´ì‹œ ëª©ë¡ì— ìˆëŠ”ì§€ í™•ì¸
            if ! grep -Fxq "$video_hash" prev_hashes.txt; then
              echo "ìƒˆ ì˜ìƒ ë°œê²¬: $video_id"
              echo "$video_hash" >> new_hashes.txt
              
              # ì œëª©ê³¼ ë‚ ì§œ ê°€ì ¸ì˜¤ê¸°
              title=$(sed -n "${line_num}p" video_titles.txt)
              date=$(sed -n "${line_num}p" video_dates.txt)
              
              # ë‚˜ì¤‘ì— ì—­ìˆœìœ¼ë¡œ ë³´ë‚´ê¸° ìœ„í•´ ì •ë³´ ì €ì¥
              echo "$video_id|$title|$date" >> new_videos_info.txt
            fi
          done < video_ids.txt
          
          # ìƒˆ ì˜ìƒì´ ìˆìœ¼ë©´ ì—­ìˆœìœ¼ë¡œ Discord ì•Œë¦¼ ì „ì†¡ (ì˜¤ë˜ëœ ê²ƒë¶€í„°)
          if [ -s new_videos_info.txt ]; then
            echo "NEW_VIDEOS=true" >> $GITHUB_ENV
            
            # ì—­ìˆœìœ¼ë¡œ ì•Œë¦¼ ì „ì†¡
            tac new_videos_info.txt | while IFS='|' read -r video_id title date; do
              message="ğŸ¥ **ìƒˆ ì˜ìƒ ì—…ë¡œë“œ!**\nì œëª©: $title\në‚ ì§œ: $date\në§í¬: https://youtu.be/$video_id"
              curl -H "Content-Type: application/json" \
                   -X POST \
                   -d "{\"content\": \"$message\"}" \
                   ${{ secrets.DISCORD_WEBHOOK_URL }}
              
              sleep 1  # Discord API ë ˆì´íŠ¸ ë¦¬ë°‹ ë°©ì§€
            done
          else
            echo "NEW_VIDEOS=false" >> $GITHUB_ENV
            echo "ìƒˆ ì˜ìƒ ì—†ìŒ"
          fi

      - name: ìƒíƒœ íŒŒì¼ ì—…ë°ì´íŠ¸  # state.jsonì— ìƒˆ í•´ì‹œ ì €ì¥ ë° GitHub í‘¸ì‹œ
        if: env.NEW_VIDEOS == 'true'
        run: |
          # ê¸°ì¡´ í•´ì‹œì™€ ìƒˆ í•´ì‹œ ë³‘í•©, ì¤‘ë³µ ì œê±°
          cat prev_hashes.txt new_hashes.txt | sort -u > all_hashes.txt
          
          # MAX_STORED ê°œìˆ˜ë§Œí¼ë§Œ ìœ ì§€ (ìµœê·¼ ê²ƒë“¤)
          tail -n ${{ env.MAX_STORED }} all_hashes.txt > final_hashes.txt
          
          # JSON í˜•ì‹ìœ¼ë¡œ ì €ì¥
          echo -n '{"posted":[' > state.json
          first=true
          while IFS= read -r hash; do
            if [ "$first" = true ]; then
              echo -n "\"$hash\"" >> state.json
              first=false
            else
              echo -n ",\"$hash\"" >> state.json
            fi
          done < final_hashes.txt
          echo ']}' >> state.json
          
          # Git ì»¤ë°‹ ë° í‘¸ì‹œ
          git config --global user.name "github-actions"
          git config --global user.email "actions@github.com"
          git add state.json
          git commit -m "ìƒˆ ì˜ìƒ í•´ì‹œ ì—…ë°ì´íŠ¸" || echo "ì»¤ë°‹í•  ë³€ê²½ì‚¬í•­ ì—†ìŒ"
          git push
